# Composition: WhoareApp Implementation
# Purpose: Implements the WhoareApp using provider-kubernetes with environment detection
# Restaurant Analogy: The "recipe" - how to prepare what was ordered
apiVersion: apiextensions.crossplane.io/v2
kind: Composition
metadata:
  name: xwhoareapp-kubernetes
spec:
  compositeTypeRef:
    apiVersion: demo.openportal.dev/v1alpha1
    kind: WhoareApp
  
  # Environment configurations are loaded and used for domain selection
  environment:
    environmentConfigs:
    - type: Selector
      selector:
        matchLabels:
        - key: environment
          type: Value
          value: "production"
    - type: Selector
      selector:
        matchLabels:
        - key: environment
          type: Value
          value: "local"
    - type: Reference
      ref:
        name: dns-config  # Global DNS config
  
  mode: Pipeline
  pipeline:
  
  # Step 1: Load environment configurations
  - step: load-environment
    functionRef:
      name: function-environment-configs
    input:
      apiVersion: environmentconfigs.crossplane.io/v1beta1
      kind: EnvironmentConfigs
      spec:
        environmentConfigs:
        - type: Selector
          selector:
            mode: Multiple
            maxMatch: 2
            minMatch: 0
            matchLabels:
            - key: environment
              type: FromCompositeFieldPath
              valueFromFieldPath: spec.environment
  
  # Step 2: Generate resources using go-templating with environment data
  - step: deploy-app
    functionRef:
      name: function-go-templating
    input:
      apiVersion: gotemplating.crossplane.io/v1beta1
      kind: GoTemplate
      source: Inline
      inline:
        template: |
          {{- $environment := .observed.composite.resource.spec.environment | default "auto-detect" }}
          {{- $replicas := .observed.composite.resource.spec.replicas | default 2 }}
          {{- $image := .observed.composite.resource.spec.image | default "traefik/whoami:v1.10.1" }}
          {{- $name := .observed.composite.resource.metadata.name }}
          
          {{/* Determine domain based on environment */}}
          {{- $domain := "whoami.localhost" }}
          {{- if .context.environment }}
            {{- if .context.environment.domain }}
              {{- $domain = .context.environment.domain }}
            {{- else if eq $environment "production" }}
              {{- $domain = "whoami.openportal.dev" }}
            {{- else if eq $environment "staging" }}
              {{- $domain = "whoami-staging.openportal.dev" }}
            {{- else if eq $environment "local" }}
              {{- $domain = "whoami.localhost" }}
            {{- end }}
          {{- end }}
          
          ---
          # Namespace
          apiVersion: kubernetes.crossplane.io/v1alpha2
          kind: Object
          metadata:
            name: {{ $name }}-namespace
            annotations:
              crossplane.io/external-name: {{ $name }}-namespace
          spec:
            forProvider:
              manifest:
                apiVersion: v1
                kind: Namespace
                metadata:
                  name: {{ $name }}
                  labels:
                    app: whoami-xr
                    instance: {{ $name }}
            providerConfigRef:
              name: kubernetes-provider
          
          ---
          # Deployment
          apiVersion: kubernetes.crossplane.io/v1alpha2
          kind: Object
          metadata:
            name: {{ $name }}-deployment
            annotations:
              crossplane.io/external-name: {{ $name }}-deployment
          spec:
            forProvider:
              manifest:
                apiVersion: apps/v1
                kind: Deployment
                metadata:
                  name: whoami
                  namespace: {{ $name }}
                  labels:
                    app: whoami-xr
                    instance: {{ $name }}
                spec:
                  replicas: {{ $replicas }}
                  selector:
                    matchLabels:
                      app: whoami-xr
                      instance: {{ $name }}
                  template:
                    metadata:
                      labels:
                        app: whoami-xr
                        instance: {{ $name }}
                    spec:
                      containers:
                      - name: whoami
                        image: {{ $image }}
                        ports:
                        - containerPort: 80
                          name: web
                        resources:
                          requests:
                            memory: "32Mi"
                            cpu: "10m"
                          limits:
                            memory: "64Mi"
                            cpu: "100m"
                        livenessProbe:
                          httpGet:
                            path: /health
                            port: 80
                          initialDelaySeconds: 10
                        readinessProbe:
                          httpGet:
                            path: /health
                            port: 80
                          initialDelaySeconds: 5
            providerConfigRef:
              name: kubernetes-provider
          
          ---
          # Service
          apiVersion: kubernetes.crossplane.io/v1alpha2
          kind: Object
          metadata:
            name: {{ $name }}-service
            annotations:
              crossplane.io/external-name: {{ $name }}-service
          spec:
            forProvider:
              manifest:
                apiVersion: v1
                kind: Service
                metadata:
                  name: whoami
                  namespace: {{ $name }}
                  labels:
                    app: whoami-xr
                    instance: {{ $name }}
                spec:
                  type: ClusterIP
                  selector:
                    app: whoami-xr
                    instance: {{ $name }}
                  ports:
                  - port: 80
                    targetPort: 80
                    protocol: TCP
                    name: http
            providerConfigRef:
              name: kubernetes-provider
          
          ---
          # Ingress with dynamic domain
          apiVersion: kubernetes.crossplane.io/v1alpha2
          kind: Object
          metadata:
            name: {{ $name }}-ingress
            annotations:
              crossplane.io/external-name: {{ $name }}-ingress
          spec:
            forProvider:
              manifest:
                apiVersion: networking.k8s.io/v1
                kind: Ingress
                metadata:
                  name: whoami
                  namespace: {{ $name }}
                  labels:
                    app: whoami-xr
                    instance: {{ $name }}
                  annotations:
                    nginx.ingress.kubernetes.io/rewrite-target: /
                spec:
                  ingressClassName: nginx
                  rules:
                  - host: {{ $domain }}
                    http:
                      paths:
                      - path: /
                        pathType: Prefix
                        backend:
                          service:
                            name: whoami
                            port:
                              number: 80
            providerConfigRef:
              name: kubernetes-provider
          
          ---
          # Status update
          apiVersion: meta.crossplane.io/v1alpha1
          kind: CompositeResourceDefinition
          status:
            domain: {{ $domain }}
  
  # Step 3: Mark as ready when all resources are created
  - step: auto-ready
    functionRef:
      name: function-auto-ready